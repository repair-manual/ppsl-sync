const templates = require('./templates.js')
const settings = require('../settings.js')
const { Repository } = require('nodegit')

function noWikiLabels (str = '') {
  return str.replace(/(:|;|\*)/g, '<nowiki>$1</nowiki>')
}

function trimDescription (str = '') {
  return str.replace(/\n\n/g, '\n').trim().replace(/\n/g, '\n:')
}

/**
 *
 * @param {Repository} repo
 * @returns
 */
async function formatter (repo, { products, problems, solutions, links }) {
  const formattedTemplates = []

  // Get hash commit
  const commitHead = (await repo.getHeadCommit()).sha()

  for (let i = 0; i < products.length; i++) {
    const product = products[i]

    const linksRef = []

    // Problems
    const problemsFormatted = []
    for (let ii = 0; ii < product.problems.length; ii++) {
      const problem = problems.find(problem => problem._id === product.problems[ii])

      // Solutions
      const solutionsFormatted = []
      for (let iii = 0; iii < problem.solutions.length; iii++) {
        const solution = solutions.find(solution => solution._id === problem.solutions[iii])

        // Links
        const linksFormatted = []
        for (let iiii = 0; iiii < solution.links.length; iiii++) {
          const link = links.find(link => link._id === solution.links[iiii])
          const linkDescriptionFormat = noWikiLabels(link.description).replace(/\n\n/g, '\n').trim()

          let ref = linksRef.find(ref => ref.url === link.url)

          if (!ref) {
            ref = { ...link, _id: `link-${linksRef.length}` }
            linksRef.push(ref)
            linksFormatted.push(`<ref name="${ref._id}">[${link.url} "${link.label}"]${linkDescriptionFormat.length > 0 ? ` ${linkDescriptionFormat}` : ''}</ref>`)
          } else {
            linksFormatted.push(`<ref name="${ref._id}" />`)
          }
        }

        const solutionLabelFormat = noWikiLabels(solution.label)
        const solutionDescriptionFormat = trimDescription(solution.description).length > 0 ? trimDescription(solution.description) : undefined

        solutionsFormatted.push(`;${solutionLabelFormat}${linksFormatted.length > 0 ? ` ${linksFormatted.join(' ')}` : ''}${solutionDescriptionFormat ? `\n:${solutionDescriptionFormat}` : ''}`)
      }

      const problemLabelFormat = noWikiLabels(problem.label)
      const problemDescriptionFormat = trimDescription(problem.description).length > 0 ? trimDescription(problem.description) : undefined
      const problemTE = templates.problemTableEntry
        .replace(/%n/g, ii + 1)
        .replace('%problem', `;${problemLabelFormat}${problemDescriptionFormat ? `\n:${problemDescriptionFormat}` : ''}`)
        .replace('%solutions', solutionsFormatted.join('\n'))

      problemsFormatted.push(problemTE)
    }

    const problemTableFormatted = templates.problemTable
      .replace('%problemTableEntries', problemsFormatted.join('\n'))

    const finalOutput = templates.finalOutput
      .replace('%generationData', `Generated by ${settings.packageJSON.name} v${settings.packageJSON.version}`)
      .replace('%helpMessage', `[${settings.appHomepage} Help contribute to this list via the PPSL-App!]`)
      .replace('%commitHash', commitHead)
      .replace('%problemTable', problemTableFormatted)

    const template = {
      title: product._id,
      content: finalOutput
    }

    formattedTemplates.push(template)
  }

  return formattedTemplates
}

module.exports = formatter
